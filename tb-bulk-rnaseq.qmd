---
title: "Tuberculosis Bulk RNA-seq Analysis"
format:
  pdf:
    toc: true
    number-sections: true
    geometry: "margin=0.5in"
    fontsize: 11pt
execute:
  warning: false
knitr:
  opts_chunk:
    fig.align: "center"
---

# Downloading and Formatting the Data
(download data from GSE, establish needed local directories, format data objects)

(describe following code)

```{r}
#| label: Setup

library(tidyverse) # dplyr, tidyr, tibble, readr
library(readxl)
library(Biobase)
library(GEOquery)

dir.create(file.path("data_raw"), showWarnings = FALSE) # establish directory to raw data downloads

supplemental_dir <- file.path("data_raw", "GSE107994") # establish path to specific study directory
```

(describe following code)

```{r}
#| label: Download-counts

if (!dir.exists(supplemental_dir) || length(list.files(supplemental_dir)) == 0) { # checks for supplemental files from GSE107994
  getGEOSuppFiles("GSE107994", baseDir = "data_raw") # accesses GEO for supplemental files (gene counts for all samples)
}

counts_file <- list.files( # grabs the specific file name for the raw gene counts data
  path = supplemental_dir,
  pattern = "Raw_counts.*Leicester.*\\.xlsx$",
  full.names = TRUE
)

counts <- readxl::read_xlsx(counts_file) # function to import .xlsx file as data table
```

(describe following code)

```{r}
#| label: Download-phenotypes

gse <- getGEO("GSE107994", GSEMatrix = TRUE) # grabs the series matrix from GEO
phenotypes <- Biobase::pData(gse[[1]]) |> as_tibble() # formats GSE download as tabular sample metadata
```

(describe following code)

```{r}
#| label: Store-data

dir.create("data_processed", showWarnings = FALSE) # create data_processed directory folder if it does not exist

readr::write_tsv(phenotypes, file.path("data_processed", "GSE107994_phenotypes.tsv")) # save phenotypes locally
readr::write_tsv(counts, file.path("data_processed", "GSE107994_counts_raw.tsv")) # save counts locally
```

{{< pagebreak >}}

# Inspecting the Data
(snapshot of counts and phenotypes tables, )

```{r}
#| label: Inspect-data

print(counts)

print(phenotypes)
```

{{< pagebreak >}}

# Data Cleaup
(reformat data, use one of the BioConductor packages to normalize, then use normalized data to plot a PCA)

```{r}
#| label: Reformat-data

counts_mat <- counts |> # convert counts tibble into a simple matrix
  select(-Gene_name, -Gene_biotype) |>
  column_to_rownames("Genes") |>
  as.matrix()

colnames(counts_mat) <- phenotypes$geo_accession[match(colnames(counts_mat), phenotypes$title)] # replace with shorter names

phenotypes_slim <- phenotypes |> # subset phenotypes to the columns of interest
  select(
    case = geo_accession,
    patient_id = 'patient_id:ch1',
    group = 'group:ch1',
    tb_disease_type = 'tb_disease_type:ch1',
    smear_result = 'smear_result:ch1',
    outlier = 'outlier:ch1',
    gender = 'gender:ch1',
    ethnicity = 'ethnicity:ch1',
    birthplace = 'birth_place:ch1',
    age_baseline = 'age_at_baseline_visit:ch1',
    timepoint_months = 'timepoint_months:ch1',
    visit_date = 'visit_date:ch1',
    title
) |>
  mutate(
    group = factor(group, levels = c("Control", "Active_TB", "LTBI", "LTBI_Progressor")),
    tb_disease_type = factor(tb_disease_type),
    smear_result = factor(smear_result, levels = c("Negative", "Positive")),
    gender = factor(gender)
  )
```

{{< pagebreak >}}

# Scenario 1
(look at baseline samples, outlier = no, all disease types, and both sexes)
(DESeq2, edgeR, and limma analyses of this subset)
