---
title: "Tuberculosis Bulk RNA-seq Analysis"
format:
  pdf:
    toc: true
    number-sections: true
    geometry: "margin=0.5in"
    fontsize: 11pt
knitr:
  opts_chunk:
    fig.align: "center"
---

# Download and Setup
(download data from GSE)

```{r}
#| label: Downloading data from GEO

library(tidyverse) # dplyr, tidyr, tibble, readr, readxl
library(GEOquery)

dir.create(file.path("data_raw"), showWarnings = FALSE) # establish directory to accomodate GEO downloads

supplemental_dir <- file.path("data_raw", "GSE107994")

if (!dir.exists(supplemental_dir) || length(list.files(supplemental_dir)) == 0) { # checks for supplemental files from GSE107994
  getGEOSuppFiles("GSE107994", baseDir = "data_raw") # accesses GEO for supplemental files (gene counts for all samples)
}

gse <- getGEO("GSE107994", GSEMatrix = TRUE) # grabs the series matrix

counts_file <- list.files( # grabs the specific file name for the raw gene counts data
  path = supplemental_dir,
  pattern = "Raw_counts.*Leicester.*\\.xlsx$",
  full.names = TRUE
)

phenotypes <- Biobase::pData(gse[[1]]) |> as_tibble() # formats GSE download as tabular sample metadata
counts <- readxl::read_xlsx(counts_file) # function to import .xlsx file as data table

if (!dir.exists("data_processed") || length(list.files("data_processed")) == 0) { # checks for extant data_processed directory
  dir.create(file.path("data_processed"))
}

write_tsv(
  x = phenotypes,
  file = file.path("data_processed", "GSE107994_phenotypes.tsv")
)

write_tsv(counts, file.path("data_processed", "GSE107994_counts_raw.tsv"))
```

